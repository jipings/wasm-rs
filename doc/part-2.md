## 二进制和文本格式

二进制格式

Wasm 二进制格式总体结构

Wasm 二进制格式也是以 Magic Number 和版本号开头。在此后是模块主体内容，这些内容放到不同的段（Section，也叫 Segment）。Segment 可能包含多个项目，Wasm规范一共定义了 12 种段，并给每个段分配了ID（0～11）。除了自定义段外，其余段最多只能出现一次，且必须按照ID递增的顺序出现。

<image src="./images/ch02_module500x230.png" />

包含的12种段：

1.  类型段（ID = 1）

2. 导入段和导出段（ID = 2/7）

3. 函数段和代码段（ID = 3/10）

4. 表段和元素段（ID = 4/9）

5. 内存段和数据段（ID = 5/11）

6. 全局段（ID = 6）

7. 起始段（ID = 8）

8. 自定义段（ID = 0）
该段是给编译器等工具使用的，里面可以存放函数调试信息，或其他任何附加信息。

索引空间

函数签名、函数、表、内存、全局变量在模块内有各自的索引空间。

实体类型

1. 值类型
wasm 1.1 规范定义了 4 种基本的值类型： i32、i64、f32、f64

2. 函数类型

3. 限制类型

4. 内存类型

5. 表类型

6. 全局变量类型

二进制格式分析

Magic Number 和 版本号
wasm 采用小端（Little-Endian）方式编码数值

类型段

导入段
一个模块可以导入4种类型的成员以供其他模块使用，4种类型分别是：函数、表、内存、全局变量。
也可以通过其他模块导入这4种类型成员。通过导入和导出，多个模块可以被链接在一起，共同完成一个复杂的功能。

函数段

表段

内存段

全局段

导出段

起始段

元素段

代码段
每个代码项都以该项所占字节数开头。目的是方便 Wasm 实现并行处理（验证、分析、编译）

数据段
元素段存放初始化数据，数据段存放内存初始化数据；
数据段包含三部分信息：内存索引（初始化哪块内存）、内存偏移量（从哪里开始初始化）、初始化数据
目前最多只能导入或定义一个内存

二进制格式解码

LEB128 （Little Endian Base 128），是一种变长编码格式（variable-length code）

解码基本类型

解码向量类型

处理 tag

解码代码项和表达式

解码整体结构

处理错误情况

实现 dump 命令

## 指令集

Wasm 指令包含两部分信息：操作码（Opcode）和操作数（Operands）。
操作码是指令的ID，决定指令将执行的操作；操作数则相当于指令的参数，决定指令的执行结果

操作码
Wasm 指令的操作码固定一个字节，因此指令集最多只能包含256条指令。
Wasm 规范一共定义了178条指令，分为5大类：

1. 控制指令（Control Instructions），共13条指令
2. 参数指令（Parametric Instruments），共2条指令
3. 变量指令（Variable Instruments），共5条指令
4. 内存指令（Memory Instruments），共25条指令
5. 数值指令（Numeric Instruments），共133条指令

立即数
操作数分为两种：静态操作数和动态操作数
静态立即参数（Static Immediate Arguments）
动态操作数（Dynamic Operands）

数值指令

1. i32.const (0x41) 带一个s32类型的立即数，使用 LEB128 有符号格式编码
2. i64.const (0x42) 带一个s64类型的立即数，使用 LEB128 有符号格式编
3. f32.const (0x43) 带一个f32类型的立即数，固定 4 字节
4. f64.const (0x44) 带一个f64类型的立即数，固定 8 字节
5. trunc_sat (0xFC) 带一个单字节的立即数

## 文本格式

Wasm 规范定义了模块的文本格式（WebAssembly Text Format， WAT）

基本结构
Wasm 文本格式使用S-表达式描述模块。这种表达式来源自 Lisp 语言，特别适合描述类似抽象语法树（Abstract Syntax Tree， AST）

文本格式提供了多种内联写法：函数域、表域、内存域、全局域可以内联导入或导出域，表域可以内联元素域，内存域可以内联数据域，函数域和导入域可以内联类型域。这些内联写法只是语法糖，WAT 编译器会做妥善处理

类型域
导入和导出域
函数域
表域和元素域
内存域和数据域
全局域
起始域
指令





